<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tianwen.core.share.dao.ShareDao">
	<resultMap id="sProductMap" type="sProduct">
		<id column="pid" property="Pid" jdbcType="INTEGER"/>
		<result column="sex" property="sex" jdbcType="INTEGER"/>
		<result column="product_name" property="productName" jdbcType="VARCHAR"/>
		<result column="market_price" property="marketPrice" jdbcType="INTEGER"/>
		<result column="shop_price" property="shopPrice" jdbcType="INTEGER"/>
		<result column="discount" property="disCount" jdbcType="FLOAT"/>
		<result column="pno" property="pno" jdbcType="VARCHAR"/>
		<result column="img" property="img" jdbcType="VARCHAR"/>
		<result column="brand_name" property="brandName" jdbcType="VARCHAR"/>
		<result column="pay_type" property="payType" jdbcType="INTEGER"/>
		<result column="product_type" property="productType" jdbcType="INTEGER"/>
		<result column="ratio" property="ratio" jdbcType="FLOAT"/>
		<result column="csid" property="csid" jdbcType="VARCHAR"/>
	</resultMap>

	<select id="getShareCount" resultType="java.util.HashMap" parameterType="java.util.HashMap">
	select min(tm.mid) as mid, sum(tmr.amount) as earnedMoney
	from t_money_record tmr, t_member tm
	where tmr.mid = tm.mid
	and (tm.mid = #{mid, jdbcType=INTEGER} or tm.openid = #{openid, jdbcType=VARCHAR} or tm.mobile = #{mobile,jdbcType=VARCHAR})
	and tmr.status = 1
	group by tm.mid
	</select>

	<sql id="queryCondition" >
			<if test="1==1">
				and t.product_type <![CDATA[<>]]> 2 and tpcs.product_type=0 and t.status=2 and t.PSCOPE !=0 and tpcs.ratio > 0
			</if>
	</sql>


	<select id="getAllProductByPage" parameterType="java.util.HashMap" resultMap="sProductMap">
		SELECT t.pid ,t.name as product_name,t.pno ,t.sex ,t.product_type,t.market_price ,t.shop_price ,t.discount ,t.pay_type ,t.status ,t.img,
		f.name as brand_name ,trunc(tpcs.ratio*t.shop_price,1)  as ratio,f.csid
		FROM s_product t
		LEFT JOIN (SELECT distinct spe.pid, tcs.name,spe.csid
		FROM s_product_entity spe
		LEFT JOIN t_car_services tcs
		ON spe.csid = tcs.csid) f
		ON t.pid = f.pid
		LEFT JOIN t_product_commission_set tpcs
		on tpcs.product_id = t.pid
		WHERE 1=1
		<include refid="queryCondition" />

	</select>

	<select id="getAllProductCount" parameterType="java.util.HashMap" resultType="Integer">
		SELECT count(1)
		FROM s_product t
		LEFT JOIN (SELECT distinct spe.pid, tcs.name
		FROM s_product_entity spe
		LEFT JOIN t_car_services tcs
		ON spe.csid = tcs.csid) f
		ON t.pid = f.pid
		LEFT JOIN t_product_commission_set tpcs
		on tpcs.product_id = t.pid
		WHERE 1=1
		<include refid="queryCondition" />

	</select>



	
</mapper>